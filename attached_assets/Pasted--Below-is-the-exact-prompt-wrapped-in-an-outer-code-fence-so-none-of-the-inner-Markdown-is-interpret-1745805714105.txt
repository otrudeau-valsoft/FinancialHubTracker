
Below is the exact prompt wrapped in an outer code-fence so none of the inner Markdown is interpreted or lost.
Copy everything from the first to the last and paste it into ChatGPT / Ghostwriter.

markdown
Copy
Edit
You are a senior TypeScript / React / Node engineer working on a Replit-hosted portfolio-monitoring app.

📂  Existing tables  
  • portfolio_usd   (ticker PK, …)  
  • portfolio_cad   (ticker PK, …)  
  • portfolio_intl  (ticker PK, …)  
  • current_prices  (ticker, price, traded_at)          -- intraday  
  • historical_prices (ticker, close, candle_date, …)   -- EOD  

⚠️  All price candles live in the *shared* current_prices / historical_prices tables — they are **not** split by USD / CAD / INTL.

I need a complete **earnings pipeline** that powers two UI views:  
  1. **HEATMAP** – aggregated stats for the latest 4 fiscal quarters.  
  2. **SINGLE-STOCK PANEL** – last 4 quarters side-by-side for any chosen ticker.

🔧  Tech stack  
Node 20, Express, Neon Postgres (or Prisma), React Query on the client.  
Use the `yahoo-finance2` npm package **only** for earnings data; whenever you need prices (e.g., next-day market reaction) read them from `historical_prices`.

────────────────────────────────────────────────────────────────────────
### WHAT TO OUTPUT
Deliver a single Markdown file with top-level headings **Schema, Service, Routes, Client, Rationale**.  
Put each code asset in a triple-back-tick block labelled with a file-name comment (e.g. `// src/scripts/updateEarnings.ts`).  
No discussion outside the required sections.

#### 1 ── DB SCHEMA (raw SQL **and** Prisma model)

```sql
earnings_quarterly (
  ticker        TEXT,
  fiscal_year   INT,
  fiscal_q      INT,           -- 1-4
  eps_actual    NUMERIC,
  eps_estimate  NUMERIC,
  rev_actual    NUMERIC,
  rev_estimate  NUMERIC,
  guidance      TEXT,          -- 'Maintained' | 'Increased' | 'Decreased'
  mkt_reaction  NUMERIC,       -- next-day % move
  score         NUMERIC,       -- formula-driven
  note          TEXT,          -- formula-driven
  updated_at    TIMESTAMP DEFAULT now(),
  PRIMARY KEY (ticker, fiscal_year, fiscal_q)
);

earnings_meta (
  ticker        TEXT PRIMARY KEY,
  last_fetched  TIMESTAMP
);
2 ── updateEarnings.ts service must
Pull a DISTINCT list of tickers from the three portfolio tables.

Call
yahooFinance.quoteSummary(ticker, { modules: ['earnings','earningsTrend'] }).

For each item in earnings.earningsChart.quarterly

Parse label "4Q2024" → { year: 2024, q: 4 }.

eps_actual / eps_estimate → from that object.

rev_actual → matching label in earnings.financialsChart.quarterly.

rev_estimate → earningsTrend.trend record whose period aligns with that quarter (e.g. '-1q', '-2q'), path revenueEstimate.avg.

guidance → use classifyGuidance(currentEPS, eps30dAgo) where
currentEPS = trend.epsTrend.current
eps30dAgo = trend.epsTrend['30daysAgo'] ?? null.

UPSERT into earnings_quarterly (composite PK keeps historical quarters, updates existing rows).

mkt_reaction → look up close T and close T+1 in historical_prices and store (closeT+1 – closeT) / closeT.

Update earnings_meta.last_fetched.

Export helpers
beatStatus(actual, est), classifyGuidance(cur, prev), computeScore(row)
(service pre-computes score and note before inserting).

3 ── Express route
POST /api/admin/update-earnings that calls the service and returns { ok: true }.

Include an example Replit cron YAML hitting this endpoint daily.

4 ── API endpoints + React Query hooks
/api/earnings?tickers=… → SELECT * FROM earnings_quarterly WHERE ticker = ANY($1);

/api/heatmap → aggregation query counting Beat / In-Line / Miss (EPS & REV) plus guidance buckets and scores for the latest 4 quarters.

Provide hooks useEarnings and useHeatmap.

5 ── Client snippets
Skeleton React components mapping DB fields to the green / yellow / red pills shown in the screenshots.